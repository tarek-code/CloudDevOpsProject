---
# Bootstrap: install Python 3.8 on Amazon Linux 2 so Ansible's modules (which require 3.8+) can run.
# Uses 'raw' so no Python is required on the target yet.
- name: Bootstrap Python 3.8 on Jenkins hosts
  hosts: service_jenkins
  gather_facts: false
  become: yes
  vars:
    ansible_become_timeout: 120
  tasks:
    - name: Install Python 3.8 and pip (Amazon Linux 2)
      ansible.builtin.raw: |
        command -v /usr/bin/python3.8 >/dev/null 2>&1 && exit 0
        export PATH="/usr/bin:/bin:/usr/sbin:/sbin"
        timeout 600 bash -c '
          amazon-linux-extras enable -y python3.8
          yum install -y python3.8 2>&1
        '
      args:
        executable: /bin/bash
      register: py_install
      changed_when: false
    - name: Ensure Python 3.8 is available
      ansible.builtin.raw: test -x /usr/bin/python3.8 && /usr/bin/python3.8 -c 'import sys; print(sys.version)'
      register: py_check
      changed_when: false
      failed_when: py_check.rc != 0

- name: Setup required packages, Jenkins, HELM in EKS, ALB IAM Setup
  hosts: service_jenkins
  become: yes
  gather_facts: yes
  # Must match Terraform: eks_cluster_name, aws_region, aws_account_id; inventory tag service = jenkins_ansible_tag
  vars:
    cluster_name: "ivolve-eks" # same as terraform var eks_cluster_name
    aws_account_id: "183631347882" # same as terraform var aws_account_id
    aws_region: "us-east-1" # same as terraform var aws_region
  roles:
    - role: Jenkins
    - role: alb-iam # ALB Controller IAM + ServiceAccount must exist before helm-install installs the controller
    - role: helm-install
