---
# Use shell for yum so we don't require the dnf Python module under python3.8
- name: Update all packages
  ansible.builtin.shell: yum update -y
  args:
    executable: /bin/bash
  changed_when: true

- name: Install required packages
  ansible.builtin.shell: |
    yum install -y git java-11-openjdk docker trivy tar unzip vim nano curl telnet \
      net-tools iputils dnsutils tcpdump traceroute netcat nmap wireshark
  args:
    executable: /bin/bash
  changed_when: true

- name: Start and enable Docker
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true

- name: Add Jenkins repo
  ansible.builtin.copy:
    dest: /etc/yum.repos.d/jenkins.repo
    content: |
      [jenkins]
      name=Jenkins repo
      baseurl=https://pkg.jenkins.io/redhat-stable
      gpgcheck=1
      gpgkey=https://pkg.jenkins.io/redhat-stable/jenkins.io.key
    mode: "0644"

- name: Import Jenkins repo GPG key
  ansible.builtin.shell: rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
  args:
    executable: /bin/bash
  changed_when: false

- name: Install Jenkins
  ansible.builtin.shell: yum install -y jenkins
  args:
    executable: /bin/bash
  changed_when: true

- name: Start and enable Jenkins
  ansible.builtin.service:
    name: jenkins
    state: started
    enabled: true

- name: Add Jenkins user to docker group
  ansible.builtin.user:
    name: jenkins
    groups: docker
    append: true
    notify: Restart Jenkins

- name: Install kubectl
  ansible.builtin.get_url:
    url: https://amazon-eks.s3.us-west-2.amazonaws.com/1.27.6/2026-01-01/bin/linux/amd64/kubectl
    dest: /usr/local/bin/kubectl
    mode: "0755"

- name: Update kubeconfig
  ansible.builtin.shell: |
    aws eks update-kubeconfig --name {{ cluster_name }} --region {{ aws_region }}

- name: Configure Jenkins Shared Library (JCasC)
  ansible.builtin.include_tasks: jenkins-shared-library.yaml
