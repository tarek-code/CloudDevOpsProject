---
- name: Download ALB IAM policy JSON
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.14.1/docs/install/iam_policy.json
    dest: "{{ role_path }}/files/alb-policy.json"
    mode: "0644"
    force: yes # we need to make this step and the others under cuz the nexst step is looking for the policy from my laptop not ec2 and the policy will be downloaded to my laptop in ec2 not laptop
    delegate_to: localhost
    run_once: true

- name: Create IAM Policy for ALB Controller (AWS CLI)
  ansible.builtin.shell: |
    aws iam create-policy \
      --policy-name AWSLoadBalancerControllerIAMPolicy \
      --policy-document file://{{ role_path }}/files/alb-policy.json \
      --description "IAM policy for AWS Load Balancer Controller"
  args:
    executable: /bin/bash
  register: iam_policy_result
  failed_when: iam_policy_result.rc != 0 and 'EntityAlreadyExists' not in iam_policy_result.stderr
  delegate_to: localhost
  run_once: true

- name: Ensure EKS OIDC IAM provider exists (AWS CLI, skip if already exists)
  ansible.builtin.shell: |
    OIDC_URL=$(aws eks describe-cluster --name {{ cluster_name }} --query 'cluster.identity.oidc.issuer' --output text 2>/dev/null | sed -e 's|https://||')
    [ -z "$OIDC_URL" ] && exit 0
    aws iam create-open-id-connect-provider \
      --url "https://$OIDC_URL" \
      --client-id-list sts.amazonaws.com \
      --thumbprint-list 9e99a48a9960b14926bb7f3b02e22da2b0ab7280 2>/dev/null || true
  args:
    executable: /bin/bash
  delegate_to: localhost
  run_once: true
  changed_when: false
  failed_when: false

- name: Create Kubernetes ServiceAccount manifest for ALB Controller
  ansible.builtin.template:
    src: serviceaccount.yaml.j2
    dest: /tmp/alb-serviceaccount.yaml
    mode: "0644"

- name: Apply ServiceAccount to cluster
  ansible.builtin.shell: kubectl apply -f /tmp/alb-serviceaccount.yaml
  register: sa_apply
  changed_when: true
