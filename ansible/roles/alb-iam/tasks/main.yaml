---
- name: Download ALB IAM policy JSON
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.14.1/docs/install/iam_policy.json
    dest: "{{ role_path }}/files/alb-policy.json"
    mode: "0644"
    force: yes # we need to make this step and the others under cuz the nexst step is looking for the policy from my laptop not ec2 and the policy will be downloaded to my laptop in ec2 not laptop
    delegate_to: localhost
    run_once: true

- name: Create IAM Policy for ALB Controller
  amazon.aws.iam_policy:
    name: AWSLoadBalancerControllerIAMPolicy
    state: present
    policy_document: "{{ lookup('file', role_path + '/files/alb-policy.json') }}"

- name: Associate IAM OIDC provider with EKS cluster
  amazon.aws.eks_oidc_provider:
    cluster_name: "{{ cluster_name }}"
    state: present

- name: Create Kubernetes ServiceAccount manifest for ALB Controller
  ansible.builtin.template:
    src: serviceaccount.yaml.j2
    dest: /tmp/alb-serviceaccount.yaml
    mode: "0644"

- name: Apply ServiceAccount to cluster
  ansible.builtin.shell: kubectl apply -f /tmp/alb-serviceaccount.yaml
  register: sa_apply
  changed_when: true
